<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REVIP - Evaluación de Ítems (Juez)</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f9fafb; color: #222; margin: 0; }
    .judge-container { max-width: 480px; margin: 0 auto; padding: 2rem 1rem 4rem 1rem; }
    .judge-card { min-height: 340px; background: #f6f8fa; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; padding: 1.5em; margin-bottom: 1.5em; }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 6px; margin: 1.2em 0 1.5em 0; overflow: hidden; }
    .progress-bar-inner { height: 100%; background: #2C0E37; border-radius: 6px; transition: width 0.3s; }
    .semantic-scale { display: flex; align-items: center; justify-content: center; gap: 0.5em; margin: 0.5em 0 1em 0; }
    .semantic-scale > span { display: flex; align-items: center; height: 1.3em; font-size: 0.95em; color: #888; }
    .semantic-radio { display: flex; flex-direction: column; align-items: center; cursor: pointer; margin: 0 0.2em; min-width: 1.7em; justify-content: center; }
    .semantic-radio input[type="radio"] { display: none; }
    .semantic-radio .circle { width: 1.3em; height: 1.3em; border-radius: 50%; border: 2px solid #b5bfc9; background: #fff; transition: border 0.2s, box-shadow 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.04); box-sizing: border-box; }
    .semantic-radio.selected .circle { border: 2.5px solid #2C0E37; background: #2C0E37; box-shadow: 0 2px 8px rgba(43,14,55,0.08); }
    .semantic-radio .label { font-size: 0.85em; color: #888; margin-top: 0.2em; min-height: 1em; }
    .judge-item-text { font-size: 1.3em; font-weight: 700; margin: 0.7em 0; text-align: center; }
    .judge-dim-header { text-align: center; font-size: 1em; color: #444; margin-bottom: 0.2em; }
    .tipo-desc { font-size: 0.92em; font-style: italic; color: #888; margin-left: 0; }
    input[type="text"], input[type="email"] { width: 100%; margin: 0.5em 0 1em 0; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.5em; font-size: 1em; box-sizing: border-box; }
    button { background: #2C0E37; color: #fff; border: none; border-radius: 12px; padding: 0.75em 1.5em; margin: 0.5em 0; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: background 0.2s, box-shadow 0.2s; font-size: 1em; }
    button:hover { background: #1a0822; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script>
    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBN0o5zWH0qlXcCoSp0RXyzuADHNLTQ9HA",
      authDomain: "revip-21caa.firebaseapp.com",
      projectId: "revip-21caa",
      storageBucket: "revip-21caa.firebasestorage.app",
      messagingSenderId: "1045312930982",
      appId: "1:1045312930982:web:0cea686e21024a35fca067",
      measurementId: "G-0201KDSYTJ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // --- Parse URL params ---
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const userId = getParam('userId');
    const projectId = getParam('projectId');
    const judgeName = getParam('nombre') || '';
    const judgeEmail = getParam('correo') || '';

    // --- State ---
    let project = null;
    let slide = 0;
    let items = [];
    let dimensiones = [];
    let subescalas = [];
    let itemRatings = [];
    let itemComments = [];
    let generalObs = '';
    let judge = { nombre: judgeName, correo: judgeEmail };
    let responseId = null;

    // --- Load project ---
    async function loadProject() {
      if (!userId || !projectId) {
        document.getElementById('app').innerHTML = '<div class="judge-card">Error: Link incompleto o inválido.</div>';
        return;
      }
      const doc = await db.collection('users').doc(userId).collection('projects').doc(projectId).get();
      if (!doc.exists) {
        document.getElementById('app').innerHTML = '<div class="judge-card">Proyecto no encontrado.</div>';
        return;
      }
      project = doc.data();
      subescalas = project.subescalas || [];
      dimensiones = project.dimensiones || [];
      items = [];
      subescalas.forEach((s, si) => {
        (s.items || '').split('\n').filter(Boolean).forEach((item, ii) => {
          items.push({
            subescala: s.nombre || `Subescala ${si+1}`,
            tipo: s.tipo,
            tipoDesc: s.tipoDesc,
            item,
            idx: items.length + 1,
            total: null,
            isLast: false
          });
        });
      });
      items.forEach((it, idx) => { it.total = items.length; it.isLast = idx === items.length - 1; });
      itemRatings = Array(items.length).fill(null).map(() => dimensiones.map(() => null));
      itemComments = Array(items.length).fill('');
      generalObs = '';
      slide = 0;
      renderSlide();
    }

    // --- Progress bar ---
    function renderProgressBar() {
      if (slide === 0 || slide === items.length + 1 || slide === items.length + 2) return '';
      let totalSlides = items.length + 1;
      let progress = Math.round((slide) / totalSlides * 100);
      return `<div class="progress-bar"><div class="progress-bar-inner" style="width:${progress}%;"></div></div>`;
    }

    // --- Slides ---
    function renderSlide() {
      if (!project) return;
      // 0: Welcome + datos juez
      if (slide === 0) {
        document.getElementById('app').innerHTML = `
          <div class="judge-container">
            <div class="judge-card">
              <div style="text-align:justify;">
                <b>Bienvenido/a.</b> Usted ha sido invitado/a como juez experto/a para evaluar el instrumento <b>${project.metadata.nombre || ''}</b>.<br><br>
                <span style="display:block;text-align:left;margin-bottom:0.2em;">Descripción: ${project.metadata.descripcion || ''}</span>
                <span style="display:block;text-align:left;margin-bottom:0.2em;">Investigadores: ${project.metadata.autor || ''}</span>
                <span style="display:block;text-align:left;margin-bottom:0.2em;">Contacto: ${project.metadata.email || ''}</span>
                ${project.metadata.instrucciones ? `<span style=\"display:block;text-align:left;margin-bottom:0.2em;\">${project.metadata.instrucciones}</span>` : ''}
                <br>
                <div style="margin:1em 0 0.5em 0;">
                  <label>Nombre del juez:<br><input type="text" id="judge-nombre" value="${judge.nombre}" placeholder="Nombre" /></label><br>
                  <label>Email del juez:<br><input type="email" id="judge-correo" value="${judge.correo}" placeholder="Correo" /></label>
                </div>
                <div style="margin-bottom:1.2em;">El instrumento consta de <b>${items.length}</b> ítems organizados en <b>${subescalas.length > 1 ? subescalas.length + ' subescalas' : '1 escala'}</b>. Le pedimos que considere cada ítem en el contexto del objetivo de medición del instrumento, y que los pueda evaluar indicando el grado de <b>${dimensiones.map(d=>d.nombre).join(', ')}</b> para cada uno. Para proceder con la evaluación, presione continuar.</div>
                <div style="text-align:center;margin-top:1.5em;"><button id="next-slide">Comenzar evaluación</button></div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('judge-nombre').oninput = e => { judge.nombre = e.target.value; };
        document.getElementById('judge-correo').oninput = e => { judge.correo = e.target.value; };
        document.getElementById('next-slide').onclick = () => {
          if (!judge.nombre || !judge.correo) {
            alert('Por favor ingrese su nombre y correo.');
            return;
          }
          slide = 1; renderSlide();
        };
        return;
      }
      // 1..N: Items
      if (slide > 0 && slide <= items.length) {
        const idx = slide - 1;
        const it = items[idx];
        const s = subescalas.find(ss => ss.nombre === it.subescala) || subescalas[0];
        let escWord = subescalas.length === 1 ? 'escala' : 'subescala';
        let tipoText = {
          'Likert': 'una escala tipo Likert',
          'Diferencial semántico': 'una escala diferencial semántica',
          'Frecuencia': 'una escala de frecuencia',
          'Sí/No': 'la dicotomía Sí o No',
          'Otro': `el siguiente formato: ${s.tipoDesc}`
        }[s.tipo] || 'un formato personalizado';
        let tipoDescText = s.tipoDesc ? ` <span class='tipo-desc'>(${s.tipoDesc})</span>` : '';
        let contextLine = `El siguiente ítem se propone para la medición de la ${escWord} <b>${it.subescala}</b>. Sus opciones de respuesta se plantean usando ${tipoText}${tipoDescText}.`;
        let html = `
          ${renderProgressBar()}
          <div style="font-size:0.98em;margin-bottom:0.7em;text-align:justify;color:#666;">${contextLine}</div>
          <div class="judge-item-text">“${it.item}”</div>
          <div style="margin:1em 0;">
            ${dimensiones.map((dim, di) => `
              <div style="margin-bottom:1em;">
                ${dim.header ? `<div class='judge-dim-header'>${dim.header}</div>` : ''}
                <div class="semantic-scale">
                  <span>${dim.izq}</span>
                  ${[...Array(dim.puntos)].map((_, pi) => `
                    <label class=\"semantic-radio${itemRatings[idx][di]===pi?' selected':''}\"> <input type=\"radio\" name=\"dim${di}-item${idx}\" ${itemRatings[idx][di]===pi?'checked':''} data-di=\"${di}\" data-pi=\"${pi}\" />
                      <span class=\"circle\"></span>
                      <span class=\"label\">${dim.puntos===3 && pi===1 ? 'Medio' : ''}</span>
                    </label>
                  `).join('')}
                  <span>${dim.der}</span>
                </div>
              </div>
            `).join('')}
          </div>
          <input type="text" class="item-comment" id="item-comment" placeholder="Comentarios (opcional)" value="${itemComments[idx]}" />
          <div style="margin:1em 0 0.5em 0;font-size:0.9em;color:#888;">Ítem ${it.idx} de ${it.total}</div>
          <div class="flex flex-center" style="justify-content:space-between;">
            <button id="prev-slide">Anterior</button>
            <button id="next-slide">Siguiente</button>
          </div>
        `;
        document.getElementById('app').innerHTML = `<div class='judge-container'><div class='judge-card'>${html}</div></div>`;
        document.querySelectorAll('.semantic-radio input[type="radio"]').forEach(radio => {
          radio.onclick = function() {
            const di = +this.getAttribute('data-di');
            const pi = +this.getAttribute('data-pi');
            itemRatings[idx][di] = pi;
            renderSlide();
          };
        });
        document.getElementById('item-comment').oninput = e => { itemComments[idx] = e.target.value; };
        document.getElementById('prev-slide').onclick = () => { slide = (slide === 1 ? 0 : slide - 1); renderSlide(); };
        document.getElementById('next-slide').onclick = () => { slide = (slide === items.length ? items.length + 1 : slide + 1); renderSlide(); };
        return;
      }
      // Observaciones generales
      if (slide === items.length + 1) {
        let html = `
          ${renderProgressBar()}
          <div style="font-size:1.1em;margin-bottom:0.7em;">Si lo desea puede dejar observaciones generales sobre el instrumento, sus ítems o sus dimensiones.</div>
          <input type="text" id="general-obs" placeholder="Observaciones generales (opcional)" value="${generalObs}" class="item-comment" />
          <div class="flex flex-center" style="justify-content:space-between;margin-top:1.5em;">
            <button id="prev-slide">Anterior</button>
            <button id="finalizar-btn">Enviar</button>
          </div>
        `;
        document.getElementById('app').innerHTML = `<div class='judge-container'><div class='judge-card'>${html}</div></div>`;
        document.getElementById('general-obs').oninput = e => { generalObs = e.target.value; };
        document.getElementById('prev-slide').onclick = () => { slide = items.length; renderSlide(); };
        document.getElementById('finalizar-btn').onclick = submitResponse;
        return;
      }
      // Thank you
      if (slide === items.length + 2) {
        document.getElementById('app').innerHTML = `<div class='judge-container'><div class='judge-card'><h2 style='margin-bottom:1em;'>¡Gracias por su evaluación!</h2><span style='display:block;text-align:left;margin-bottom:0.2em;'><b>${project.metadata.nombre || ''}:</b> ${project.metadata.descripcion || ''}</span><span style='display:block;text-align:left;margin-bottom:0.2em;'>Investigadores: ${project.metadata.autor || ''}</span><span style='display:block;text-align:left;margin-bottom:0.2em;'>Contacto: ${project.metadata.email || ''}</span></div></div>`;
        return;
      }
    }

    // --- Submit response ---
    async function submitResponse() {
      // Validate all items
      for (let i = 0; i < items.length; i++) {
        for (let d = 0; d < dimensiones.length; d++) {
          if (itemRatings[i][d] === null) {
            alert('Por favor responde todas las dimensiones de todos los ítems.');
            return;
          }
        }
      }
      if (!judge.nombre || !judge.correo) {
        alert('Por favor ingresa tu nombre y correo.');
        slide = 0; renderSlide();
        return;
      }
      // Save response
      const response = {
        judge: { ...judge },
        submittedAt: new Date().toISOString(),
        ratings: itemRatings,
        comments: itemComments,
        generalObs,
        items: items.map(it => ({ item: it.item, subescala: it.subescala })),
        dimensiones: dimensiones.map(d => d.nombre)
      };
      await db.collection('users').doc(userId).collection('projects').doc(projectId).collection('responses').add(response);
      slide = items.length + 2;
      renderSlide();
    }

    // --- Start ---
    loadProject();
  </script>
</body>
</html> 